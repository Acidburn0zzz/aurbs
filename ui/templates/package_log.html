{% extends "base.html" %}

{% block title %}{{ pkg.name }} :: log{% endblock %}

{% block path %}
	{{ super () }}
	{{ bclink('package_list', 'Packages') }}
	{{ bclink('package_view', pkg.name, args={'pkgname': pkg.name}) }}
	{{ bclink('package_log', 'Log', args={'pkgname': pkg.name, 'build_arch': build_arch}) }}
{% endblock %}

{% block javascript %}
{{ super() }}
<script src="{{ url_for('static', filename='js/ansispan.js') }}" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">

var building = {{ 'true' if building else 'false' }};
var pkgname = "{{ pkg.name }}";
var build_arch = "{{ build_arch }}";
var logbuffer = "";
var refreshing = false;
var autoscroll = true;

function scrollto(offset=0){
	$("html, body").animate({ scrollTop: $(document).height()-$(window).height()+offset });
}

function display_log(logstr) {
	var html = ansispan(logstr);
	$("#console").html(html);
	if(autoscroll) {
		if(building) {
			scrollto(-30);
		}
		else {
			//scrollto(0);
		}
	}
}

function refresh_done() {
	building = false;
	$("#console").removeClass('loading');
}

function get_log(set_done=false) {
	if(!refreshing) {
		refreshing = true;
		var seek_param = set_done?"":"?seek=" + logbuffer.length;
		$.ajax({
			url: "{{ url_for('package_log_txt', pkgname=pkg.name, build_arch=build_arch) }}" + seek_param,
			dataType: "text",
			success: function(data) {
				if(data.length > 0) {
					logbuffer += data;
					display_log(logbuffer);
					if(set_done) {
						refresh_done();
					}
				}
			},
			complete: function() {
				refreshing = false;
			}
		});
	}
}

$(document).ready(function() {
	if(building) {
		get_log();
		window.setInterval(function() {
			if(building) {
				$.getJSON('{{ url_for('status_json') }}', function(status) {
					if(status.building != pkgname || status.arch != build_arch) {
						refresh_done();
						if(autoscroll) {
							scrollto(0);
						}
					}
				});
				get_log();
			}
		}, 5000);
	}
	else {
		get_log(true);
	}
});

</script>

{% endblock %}

{% block container %}
	<div class="row">
		<div class="span12">
			<div class="row">
				<div class="span9">
					<h1>{{ pkg.name }} {{ pkg.version if pkg.version != 'n/a' }} :: {{ build_arch }}</h1>
				</div>
			</div>
			<div class="row">
				<span class="span12">
					<pre class="loading" id="console"></pre>
				</span>
			</div>
		</div>
	</div>
{% endblock %}
